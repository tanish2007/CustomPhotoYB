<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 2: Upload Event Photos - Photo Selection</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            background: #f0f0f0;
            color: #666;
        }
        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .step.completed {
            background: #4CAF50;
            color: white;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .reference-status {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .reference-status.no-reference {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }
        .reference-status .info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .reference-status .icon {
            font-size: 24px;
        }
        .reference-status a {
            color: #1976d2;
            text-decoration: none;
        }
        .reference-status a:hover {
            text-decoration: underline;
        }
        .face-filter-note {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .face-filter-note h4 {
            margin: 0 0 5px 0;
            color: #667eea;
        }
        .face-filter-note p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>Upload Your Photos</h1>
            <p>Upload all your event photos - we'll find and select the best ones of your child</p>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator">
            {% if reference_count > 0 %}
            <div class="step completed">
                <span class="step-number">&#10003;</span>
                <span>Reference Photos</span>
            </div>
            <div class="step active">
                <span class="step-number">2</span>
                <span>Upload Event Photos</span>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <span>Review Matches</span>
            </div>
            <div class="step">
                <span class="step-number">4</span>
                <span>Final Results</span>
            </div>
            {% else %}
            <div class="step">
                <span class="step-number">1</span>
                <span>Reference Photos</span>
            </div>
            <div class="step active">
                <span class="step-number">2</span>
                <span>Upload Event Photos</span>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <span>View Results</span>
            </div>
            {% endif %}
        </div>

        <!-- Reference Status -->
        {% if reference_count > 0 %}
        <div class="reference-status">
            <div class="info">
                <span class="icon">&#128100;</span>
                <span><strong>{{ reference_count }}</strong> reference photo(s) loaded - AI will find your child in uploaded photos</span>
            </div>
            <a href="/step1">Change reference photos</a>
        </div>
        {% else %}
        <div class="reference-status no-reference">
            <div class="info">
                <span class="icon">&#9888;</span>
                <span>No reference photos loaded - processing all photos without filtering</span>
            </div>
            <a href="/step1">Add reference photos</a>
        </div>
        {% endif %}

        <!-- Upload Section -->
        <section id="upload-section" class="section">
            <div class="upload-card">
                <div class="upload-area" id="drop-zone">
                    <div class="upload-icon">photos</div>
                    <h2>Drop all event photos here or click to browse</h2>
                    <p>Supports JPG, PNG, HEIC, WebP (up to 1000+ photos)</p>
                    <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png,.heic,.heif,.webp" hidden>
                    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        Select Photos
                    </button>
                </div>

                {% if reference_count > 0 %}
                <div class="face-filter-note">
                    <h4>How Face Filtering Works:</h4>
                    <p>The AI will scan all uploaded photos using InsightFace to find ones containing your child, then apply quality-based selection on those photos only.</p>
                </div>
                {% endif %}

                <!-- Settings -->
                <div class="settings-panel">
                    <h3>Selection Settings</h3>
                    <p class="settings-description">Control how strict the quality filter should be.</p>

                    <div class="settings-grid">
                        <div class="setting-item quality-mode-setting">
                            <label>Quality Mode</label>
                            <div class="quality-buttons">
                                <button class="quality-btn" data-mode="lenient" onclick="setQualityMode('lenient')">
                                    <span class="quality-icon">photo_library</span>
                                    <span class="quality-label">Keep More</span>
                                    <span class="quality-desc">Lower standards, more photos</span>
                                </button>
                                <button class="quality-btn active" data-mode="balanced" onclick="setQualityMode('balanced')">
                                    <span class="quality-icon">auto_awesome</span>
                                    <span class="quality-label">Balanced</span>
                                    <span class="quality-desc">Recommended setting</span>
                                </button>
                                <button class="quality-btn" data-mode="strict" onclick="setQualityMode('strict')">
                                    <span class="quality-icon">workspace_premium</span>
                                    <span class="quality-label">Best Only</span>
                                    <span class="quality-desc">Highest quality only</span>
                                </button>
                            </div>
                        </div>

                        <div class="setting-item">
                            <label for="similarity">Duplicate Detection</label>
                            <input type="range" id="similarity" min="0.80" max="0.98" step="0.02" value="0.92">
                            <div class="slider-labels">
                                <span>Keep similar</span>
                                <span id="similarity-value">92%</span>
                                <span>Remove similar</span>
                            </div>
                            <span class="setting-hint">How different photos must be to both be kept</span>
                        </div>
                    </div>
                </div>

                <!-- File Preview -->
                <div id="file-preview" class="file-preview hidden">
                    <h3>Selected Files: <span id="file-count">0</span></h3>
                    <div id="preview-grid" class="preview-grid"></div>
                    <button class="btn btn-success" id="process-btn" onclick="startProcessing()">
                        {% if reference_count > 0 %}
                        Find My Child & Select Best Photos
                        {% else %}
                        Select Best Photos
                        {% endif %}
                    </button>
                </div>
            </div>
        </section>

        <!-- Processing Section -->
        <section id="processing-section" class="section hidden">
            <div class="processing-card">
                <div class="processing-animation">
                    <div class="spinner"></div>
                </div>
                <h2 id="processing-message">Processing your photos...</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p class="progress-text"><span id="progress-percent">0</span>%</p>

                <div class="processing-steps">
                    {% if reference_count > 0 %}
                    <!-- Face filtering mode: simplified steps -->
                    <div class="step" id="step-0">
                        <span class="step-icon">face</span>
                        <span>Finding Your Child</span>
                    </div>
                    <div class="step" id="step-1">
                        <span class="step-icon">photo_library</span>
                        <span>Creating Thumbnails</span>
                    </div>
                    <div class="step" id="step-2">
                        <span class="step-icon">check</span>
                        <span>Preparing Review</span>
                    </div>
                    {% else %}
                    <!-- Full processing mode -->
                    <div class="step" id="step-1">
                        <span class="step-icon">brain</span>
                        <span>AI Analysis</span>
                    </div>
                    <div class="step" id="step-2">
                        <span class="step-icon">calendar</span>
                        <span>Date Organization</span>
                    </div>
                    <div class="step" id="step-3">
                        <span class="step-icon">group</span>
                        <span>Grouping Similar</span>
                    </div>
                    <div class="step" id="step-4">
                        <span class="step-icon">star</span>
                        <span>Quality Scoring</span>
                    </div>
                    <div class="step" id="step-5">
                        <span class="step-icon">check</span>
                        <span>Final Selection</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="section hidden">
            <div class="results-header">
                <h2>Selection Results</h2>
                <div class="results-actions">
                    <button class="btn btn-primary" onclick="downloadSelected()">
                        Download Selected Photos
                    </button>
                    <button class="btn btn-secondary" onclick="resetApp()">
                        Start Over
                    </button>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Uploaded</div>
                </div>
                {% if reference_count > 0 %}
                <div class="stat-card">
                    <div class="stat-value" id="stat-found">0</div>
                    <div class="stat-label">With Your Child</div>
                </div>
                {% endif %}
                <div class="stat-card highlight">
                    <div class="stat-value" id="stat-selected">0</div>
                    <div class="stat-label">Final Selection</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-rejected">0</div>
                    <div class="stat-label">Filtered Out</div>
                </div>
            </div>

            <!-- Face Filter Stats (if applicable) -->
            <div id="face-filter-stats" class="rejection-breakdown hidden">
                <h3>Face Filtering Results:</h3>
                <div id="face-filter-bars"></div>
            </div>

            <!-- Rejection Breakdown -->
            <div class="rejection-breakdown" id="rejection-breakdown">
                <h3>Why Photos Were Filtered Out:</h3>
                <div class="rejection-bars" id="rejection-bars"></div>
            </div>

            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab active" data-tab="selected" onclick="switchTab('selected')">
                    Selected Photos
                </button>
                <button class="tab" data-tab="rejected" onclick="switchTab('rejected')">
                    Filtered Out
                </button>
            </div>

            <!-- Selected Photos Grid -->
            <div id="selected-tab" class="tab-content active">
                <div class="photo-grid" id="selected-grid"></div>
            </div>

            <!-- Rejected Photos Grid -->
            <div id="rejected-tab" class="tab-content">
                <div class="photo-grid" id="rejected-grid"></div>
            </div>
        </section>

        <!-- Photo Modal -->
        <div id="photo-modal" class="modal hidden">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal()">&times;</span>
                <img id="modal-image" src="" alt="">
                <div class="modal-info">
                    <h3 id="modal-filename"></h3>
                    <div id="modal-reason" class="modal-reason"></div>
                    <div class="score-breakdown" id="modal-scores"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Include reference count for JavaScript
        const hasReferences = {{ reference_count }} > 0;
    </script>
    <script src="/static/js/app.js"></script>
</body>
</html>
